<!DOCTYPE html>
<html>
<head>

	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="viewport" content="width = device-width">

	<title></title>

	<script src="{{=URL('static','js/jquery.js')}}"></script>
	<script src="{{=URL('static','js/web2py.js')}}"></script>
	<script src="{{=URL('static','js/audio.js')}}"></script>
	<script src="{{=URL('static','js/cognitive_prompts.js')}}"></script>
	<script src="{{=URL('static','js/attributions.js')}}"></script>
	
	<script src="{{=URL('static','js/log.js')}}"></script>

	<link rel="stylesheet" type="text/css" href="{{=URL('static','css/robot-ui.css')}}">

	<script>
		var REQUEST_DATA_FROM_MOBILE = "{{=URL('mobileinterface','default','send_data_to_robot')}}";
		var LOG = "{{=URL('mobileinterface','log','log')}}";

		//Called this asynchronously. Can't believe this worked.
    	$.ajax({
		    type: 'GET',
		    url: 'session/current_session',
		    dataType: 'json',
		    success: function(datum) {console.dir("DATA!!!" + datum); storeTestSessionInformation(datum);},
		    async: false
		});

		var direction = undefined;
		var raw_direction = undefined;
		var offset = 0;
 		var currentPromptIndex = 0;
 		var localProblemIndex = 540;
 		var begLast = false;
 		var recordClickCount = 0;
 		var promptsFinished = false;
 		var promptsOrdered = false;
 		var prompts = [ [{"text": "Can you show me what steps to take to get to where I need to go on the x-axis? Make sure to start at the origin when counting units on the x-axis!", "sound_file":"01.aiff"}, {"text": "I'm confused...can you show me what steps to take to get to where I need to go on the y-axis? Don't forget to start at the origin when counting units on the y-axis!", "sound_file":"02.aiff"}, {"text": "Can you show me what would happen if I started at the origin and moved 1 unit up on the y-axis? I would be standing on the 1, right? ", "sound_file":"03.aiff"}, {"text": "Can you show me what would happen if I started at the origin and moved 1 unit right on the x-axis? I would be standing on the 1, right? ", "sound_file":"04.aiff"}], [{"text": "The first coordinate tells me to move left or right. Can you point in the direction the second coordinate tells me to move?", "sound_file":"11.aiff"}, {"text": "The second coordinate tells me to move up or down. Can you point in the direction the first coordinate tells me to move?", "sound_file":"12.aiff"}, {"text": "Wait, does each number tell me to move in a different direction? Show me which way the first number tells me to go.", "sound_file":"13.aiff"}, {"text": "Refresh my memory...the two numbers tell me to go in different directions, right? Can you point in the direction the second number tells me to move?", "sound_file":"14.aiff"}], [{"text": "I forgot which number is the x coordinate! Can you point it out for me?", "sound_file":"21.aiff"}, {"text": "I have a feeling the second number is the y-coordinate...can you point out the y-coordinate for me so I know if this is right?", "sound_file":"22.aiff"}, {"text": "Can you show me which axis the first number in the (x, y) coordinate tells me to move on?", "sound_file":"23.aiff"}, {"text": "Hmmm can you point to the axis the second number tells me to move on?", "sound_file":"24.aiff"}], [{"text": "I’m trying to remember where all the x’s are positive. Can you show me if it's to the left or right of the origin?", "sound_file":"31.aiff"}, {"text": "Wait...can you point to where all the x's are negative?", "sound_file":"32.aiff"}, {"text": "I want to understand positive and negative values better...could you move to the left side of the x-axis and tell me if x is positive or negative there?", "sound_file":"33.aiff"}, {"text": "Could you check something for me? If you move to the right side of the x-axis, the x's are positive there, right?", "sound_file":"34.aiff"}], [{"text": "I forgot something... Can you touch the area where the y’s are all positive?", "sound_file":"41.aiff"}, {"text": "I can't remember if the negative y's are at the top or the bottom, can you point them out for me?", "sound_file":"42.aiff"}, {"text": "I wish I could remember where the positive and negative values are...could you move up to the top of the y-axis and tell me if y is positive or negative there?", "sound_file":"43.aiff"}, {"text": "Um can you show me what would happen if I moved down on the y-axis? Would the y-values be positive or negative?", "sound_file":"44.aiff"}] ];
 		var parsedData = "";


	    window.addEventListener('deviceorientation', function(e) {
	            var prop = e.alpha;
	            raw_direction = prop;

	            if(direction === undefined || Math.abs((prop + offset)%360 - direction) > 1){
	                direction = (prop + offset) % 360;
	                // document.getElementById("output").innerText = direction;
	                // Sending direction to controller
	                $.ajax({
	                      url: "{{=URL('update_direction')}}",
	                      data: {d: direction}
	                    });
	            }
	    }, false);

		socket = web2py_websocket('ws://{{=ip}}:{{=port}}/realtime/{{=group_name}}',function(e) {
			var data = JSON.parse(e.data);

			var incoming = JSON.parse(unescape(e.data));
			console.dir("incoming packet : " + JSON.stringify(incoming));
			
			var condition = "do_not_care";
			switch(data.type){
				case 'attribution':
					attributions.makeAttribution(data.value);
					break;
				case 'order':
					if(!promptsOrdered)
					{
						cognitive_prompts.doPromptAction("randomizePrompts",data.value);
						promptsOrdered = true;
					}					
				case 'cognitive':
					//condition = parsedData;
					cognitive_prompts.doPromptAction("makePrompt",data.value,parsedData ? parsedData.condition_name : "");
					break;
				case 'cognitive_skip':
					cognitive_prompts.doPromptAction("skipPrompts",data.value,"dontCare");
					break;
				case 'dismiss_cognitive':
					// TODO
					cognitive_prompts.doPromptAction("hidePromptDialog",data.value,"dontCare");
					break;
				case 'timecheck':
					cognitive_prompts.doPromptAction("timecheck",data.value,"dontcare")
					break;
				case 'reset':
					offset = 360 - raw_direction;
			}
		});

		$(function(){
			var currClass;
			
			$("body > div:not(#overlay,#speech,#record)").on("touchstart", function(){
				console.dir("start touch");
				currClass = $("body").attr('class');
				$("body").attr('class', 'frown');
				return false;
			});

			$("body > div:not(#overlay,#speech,#record)").on("touchend", function(){
				console.dir("end touch");
				$("body").attr('class', currClass);
				notifyClick();
				return false;
			});

			var notifyClick = function(){
				// Notifying mobile application
				$.ajax({url:"robot/load_options", 
			      	success: function(data) {
			          console.dir(data);
			    	}
			    });

			    //dismiss any visible prompts
			    recordClickCount = 5;
			    $("#record").click();

			    // Notifying user
			    showClick();
			};

			var showClick = function(){
				console.dir('clicked');
				$('#overlay').fadeIn('slow');
				window.setTimeout(function(){
					$('#overlay').fadeOut('slow');
				}, 3000);
			};

			$.ajax({
				url:"{{=URL('session', 'current_session')}}"
			}).done(function(data){
				parsedData = JSON.parse(JSON.parse(data));
			});

		});
		
	</script>

</head>
<body class="neutral">
	<div id="output"></div>
	<div id="eyes"></div>
	<div id="mouth"></div>
	<div id="speech"></div>
	<div id="record"></div>
	<div id="overlay"></div>
	<audio id="promptSound"/>
	<audio id="attributionSound"/>
</body>
</html>
