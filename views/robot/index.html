<!DOCTYPE html>
<html>
<head>

	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="viewport" content="width = device-width">

	<title></title>

	<script src="{{=URL('static','js/jquery.js')}}"></script>
    	<script src="{{=URL('static','js/web2py.js')}}"></script>
    	<script src="{{=URL('static','js/audio.js')}}"></script>
    	<script src="{{=URL('static','js/attributions.js')}}"></script>
    	<script src="{{=URL('static','js/cognitive_prompts.js')}}"></script>

	<link rel="stylesheet" type="text/css" href="{{=URL('static','css/robot-ui.css')}}">

	<script>
		var direction = undefined;
		var raw_direction = undefined;
		var offset = 0;
 		var currentPromptIndex = 0;
 		var localProblemIndex = 540;
 		var begLast = false;
 		var recordClickCount = 0;
 		var promptsFinished = false


	    window.addEventListener('deviceorientation', function(e) {
	            var prop = e.alpha;
	            raw_direction = prop;

	            if(direction === undefined || Math.abs((prop + offset)%360 - direction) > 1){
	                direction = (prop + offset) % 360;
	                // document.getElementById("output").innerText = direction;
	                // Sending direction to controller
	                $.ajax({
	                      url: "{{=URL('update_direction')}}",
	                      data: {d: direction}
	                    });
	            }
	    }, false);


		socket = web2py_websocket('ws://{{=ip}}:{{=port}}/realtime/{{=group_name}}',function(e){
			var data = JSON.parse(e.data);
			switch(data.type){
				case 'attribution':
					attributions.makeAttribution(data.value);
					break;
				case 'cognitive':
					cognitive_prompts.makePrompt(data.value);
					break;
				case 'reset':
					offset = 360 - raw_direction;
			}
		});

		$(function(){
			var currClass;
			
			$("body > div:not(#overlay,#speech,#record)").on("touchstart", function(){
				console.dir("start touch");
				currClass = $("body").attr('class');
				$("body").attr('class', 'frown');
				return false;
			});

			$("body > div:not(#overlay,#speech,#record)").on("touchend", function(){
				console.dir("end touch");
				$("body").attr('class', currClass);
				notifyClick();
				return false;
			});

			var notifyClick = function(){
				// Notifying mobile application
				$.ajax({url:"robot/load_options", 
			      	success: function(data) {
			          console.dir(data);
			    	}
			    });

			    //dismiss any visible prompts
			    recordClickCount = 5;
			    $("#record").click();

			    // Notifying user
			    showClick();
			};

			var showClick = function(){
				console.dir('clicked');
				$('#overlay').fadeIn('slow');
				window.setTimeout(function(){
					$('#overlay').fadeOut('slow');
				}, 3000);
			};

		});
		
	</script>

</head>
<body class="neutral">
	<div id="output"></div>
	<div id="eyes"></div>
	<div id="mouth"></div>
	<div id="speech"></div>
	<div id="record"></div>
	<div id="overlay"></div>
	<audio id="promptSound"/>
</body>
</html>
