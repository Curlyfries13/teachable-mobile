<!DOCTYPE html>
<html>
<head>

	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="viewport" content="width = device-width">

	<title></title>

	<script src="{{=URL('static','js/jquery.js')}}"></script>
	<script src="{{=URL('static','js/web2py.js')}}"></script>
	<script src="{{=URL('static','js/audio.js')}}"></script>
	<script src="{{=URL('static','js/attributions.js')}}"></script>

	<link rel="stylesheet" type="text/css" href="{{=URL('static','css/robot-ui.css')}}">

	<script>
		var direction = undefined;
		var raw_direction = undefined;
		var offset = 0;

		window.addEventListener('deviceorientation', function(e) {
			var prop = e.alpha;
			raw_direction = prop;

			if(direction === undefined || Math.abs((prop + offset)%360 - direction) > 0.1){
			    direction = (prop + offset) % 360;
			    document.getElementById("output").innerText = direction;
			    // Sending direction to controller
			    $.ajax({
				  url: "{{=URL('update_direction')}}",
				  data: {d: direction}
				});
			}
		}, false);

		socket = web2py_websocket('ws://{{=ip}}:{{=port}}/realtime/{{=group_name}}',function(e){
			var data = JSON.parse(e.data);
			switch(data.type){
				case 'attribution':
					attributions.makeAttribution(data.value);
					break;
				case 'reset':
					offset = 360 - raw_direction;
					// alert(offset);
			}
		});
		
	</script>

</head>
<body class="neutral">
<div id="output"></div>
<div id="eyes"></div>
<div id="mouth"></div>

<audio id="attributionSound"/>

</body>
</html>